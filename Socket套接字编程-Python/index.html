<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="eDOzvx6bLa35ERASnwMlfL2riQA9TP0zTVfD6EgOJ3g"><meta name="baidu-site-verification" content="code-3ctHbzQupT"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"hoper-j.github.io",root:"/",scheme:"Mist",version:"7.8.0",exturl:!1,sidebar:{position:"right",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"default"},back2top:{enable:!1,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"valin",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="本文内容基于计网自顶向下第二章的套接字编程作业： 1.Web 服务器 2.UDP ping 程序 3.邮件客户端 4. 多线程 Web 代理服务器 以下基于Web官网所给作业框架完成，包含拓展部分 作业细节（官网）自取：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1BYlQNwsjc9QCpeOQQ_R0ZQ  密码: vgfl 下面的代码也同步放在了github上： ps: 以下代码均可跑"><meta property="og:type" content="article"><meta property="og:title" content="socket套接字编程-Python"><meta property="og:url" content="https://hoper-j.github.io/Socket%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B-Python/index.html"><meta property="og:site_name" content="Hoper-J"><meta property="og:description" content="本文内容基于计网自顶向下第二章的套接字编程作业： 1.Web 服务器 2.UDP ping 程序 3.邮件客户端 4. 多线程 Web 代理服务器 以下基于Web官网所给作业框架完成，包含拓展部分 作业细节（官网）自取：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1BYlQNwsjc9QCpeOQQ_R0ZQ  密码: vgfl 下面的代码也同步放在了github上： ps: 以下代码均可跑"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210415163722.png"><meta property="og:image" content="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210425171901.png"><meta property="og:image" content="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210425172041.png"><meta property="article:published_time" content="2021-04-14T02:44:47.000Z"><meta property="article:modified_time" content="2021-04-25T09:24:23.459Z"><meta property="article:author" content="J"><meta property="article:tag" content="计算机网络"><meta property="article:tag" content="Python"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210415163722.png"><link rel="canonical" href="https://hoper-j.github.io/Socket%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B-Python/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>socket套接字编程-Python | Hoper-J</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Hoper-J</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">星光不负赶路人</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://hoper-j.github.io/Socket%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B-Python/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/images/avatar.gif"><meta itemprop="name" content="J"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Hoper-J"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">socket套接字编程-Python</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-04-14 10:44:47" itemprop="dateCreated datePublished" datetime="2021-04-14T10:44:47+08:00">2021-04-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-04-25 17:24:23" itemprop="dateModified" datetime="2021-04-25T17:24:23+08:00">2021-04-25</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Book/" itemprop="url" rel="index"><span itemprop="name">Book</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Book/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%EF%BC%9A%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/" itemprop="url" rel="index"><span itemprop="name">计算机网络：自顶向下</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Book/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%EF%BC%9A%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B/%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B%E4%BD%9C%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">套接字编程作业</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/Socket%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B-Python/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/Socket%E5%A5%97%E6%8E%A5%E5%AD%97%E7%BC%96%E7%A8%8B-Python/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>16k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>14 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>本文内容基于计网自顶向下第二章的套接字编程作业：</p><p>1.Web 服务器 2.UDP ping 程序 3.邮件客户端 4. 多线程 Web 代理服务器</p><p>以下基于Web官网所给<a target="_blank" rel="noopener external nofollow noreferrer" href="https://media.pearsoncmg.com/ph/esm/ecs_kurose_compnetwork_8/cw/content/python-socket-programming-assignments.zip">作业框架</a>完成，包含拓展部分</p><p>作业细节（官网）自取：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://pan.baidu.com/s/1BYlQNwsjc9QCpeOQQ_R0ZQ">https://pan.baidu.com/s/1BYlQNwsjc9QCpeOQQ_R0ZQ</a> 密码: vgfl</p><p>下面的代码也同步放在了github上：</p><p>ps: 以下代码均可跑通，做了部分注解，后续有需要再补相关说明</p></blockquote><h1 id="如何在一台电脑上运行服务器和客户端"><a href="#如何在一台电脑上运行服务器和客户端" class="headerlink" title="如何在一台电脑上运行服务器和客户端"></a>如何在一台电脑上运行服务器和客户端</h1><p>开两个终端（terminal）分别运行，或者Pycharm+终端，抑或其他的，能跑就行</p><h1 id="实现简单Web服务器（TCP）"><a href="#实现简单Web服务器（TCP）" class="headerlink" title="实现简单Web服务器（TCP）"></a>实现简单Web服务器（TCP）</h1><h2 id="webserver-py"><a href="#webserver-py" class="headerlink" title="webserver.py"></a>webserver.py</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys  <span class="comment"># In order to terminate the program</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SERVER = gethostbyname(gethostname())</span><br><span class="line">PORT = <span class="number">18888</span></span><br><span class="line">ADDR = (SERVER, PORT)</span><br><span class="line"></span><br><span class="line">BUFSIZE = <span class="number">4096</span></span><br><span class="line">FORMAT = <span class="string">&#x27;UTF-8&#x27;</span></span><br><span class="line"></span><br><span class="line">serverSocket = socket(AF_INET, SOCK_STREAM) <span class="comment">#Prepare a sever socket</span></span><br><span class="line">serverSocket.bind(ADDR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    print(<span class="string">&#x27;Ready to serve...&#x27;</span>)</span><br><span class="line">    serverSocket.listen()</span><br><span class="line">    connectionSocket, addr = serverSocket.accept()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        message = connectionSocket.recv(BUFSIZE).decode(FORMAT)</span><br><span class="line"></span><br><span class="line">        filename = message.split()[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        f = <span class="built_in">open</span>(filename[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">        outputdata = f.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Send one HTTP header line into socket</span></span><br><span class="line">        connectionSocket.send(<span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span>.encode(FORMAT))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Send the content of the requested file to the client</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(outputdata)):</span><br><span class="line">            connectionSocket.send(outputdata[i].encode())</span><br><span class="line">        connectionSocket.send(<span class="string">&quot;\r\n&quot;</span>.encode())</span><br><span class="line"></span><br><span class="line">        connectionSocket.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> IOError:</span><br><span class="line">        <span class="comment"># Send response message for file not found</span></span><br><span class="line">        connectionSocket.send(<span class="string">&#x27;HTTP/1.1 404 Not found\r\n\r\n&#x27;</span>.encode(FORMAT))</span><br><span class="line">        connectionSocket.send(<span class="string">&#x27;文件不存在\r\n&#x27;</span>.encode(FORMAT))</span><br><span class="line">        <span class="comment"># Close client socket</span></span><br><span class="line">        connectionSocket.close()</span><br><span class="line"></span><br><span class="line">    serverSocket.close()</span><br><span class="line">    sys.exit()  <span class="comment"># Terminate the program after sending the corresponding data</span></span><br></pre></td></tr></table></figure><h2 id="多线程-webserver-thread-py"><a href="#多线程-webserver-thread-py" class="headerlink" title="多线程 webserver_thread.py"></a>多线程 webserver_thread.py</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys  <span class="comment"># In order to terminate the program</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">SERVER = gethostbyname(gethostname())</span><br><span class="line">PORT = <span class="number">18888</span></span><br><span class="line">ADDR = (SERVER, PORT)</span><br><span class="line"></span><br><span class="line">HEADER = <span class="number">64</span></span><br><span class="line">BUFSIZE = <span class="number">4096</span></span><br><span class="line">FORMAT = <span class="string">&#x27;UTF-8&#x27;</span></span><br><span class="line">CLOSE_CONNECTION = <span class="string">&#x27;!QUIT&#x27;</span></span><br><span class="line"></span><br><span class="line">serverSocket = socket(AF_INET, SOCK_STREAM) <span class="comment">#Prepare a sever socket</span></span><br><span class="line">serverSocket.bind(ADDR)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>():</span></span><br><span class="line">    print(<span class="string">&#x27;Ready to serve...&#x27;</span>)</span><br><span class="line">    serverSocket.listen()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        connectionSocket, addr = serverSocket.accept()</span><br><span class="line">        thread = threading.Thread(target=handle_client, args=(connectionSocket,))</span><br><span class="line">        thread.start()</span><br><span class="line">        print(<span class="string">f&quot;[当前连接数量]: <span class="subst">&#123;threading.activeCount() - <span class="number">1</span>&#125;</span>&quot;</span>) <span class="comment"># 去除创立的线程</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_client</span>(<span class="params">connectionSocket</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            message = connectionSocket.recv(BUFSIZE).decode(FORMAT)</span><br><span class="line">            <span class="keyword">if</span> message == CLOSE_CONNECTION:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            filename = message.split()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            f = <span class="built_in">open</span>(filename[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">            outputdata = f.readlines()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Send one HTTP header line into socket</span></span><br><span class="line">            connectionSocket.send(<span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span>.encode(FORMAT))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Send the content of the requested file to the client</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(outputdata)):</span><br><span class="line">                connectionSocket.send(outputdata[i].encode())</span><br><span class="line">            connectionSocket.send(<span class="string">&quot;\r\n&quot;</span>.encode())</span><br><span class="line"></span><br><span class="line">            <span class="comment"># connectionSocket.close()</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> (OSError, IOError):</span><br><span class="line">            <span class="comment"># Send response message for file not found</span></span><br><span class="line"></span><br><span class="line">            connectionSocket.send(<span class="string">&#x27;HTTP/1.1 404 Not found\r\n\r\n&#x27;</span>.encode(FORMAT))</span><br><span class="line">            <span class="comment"># connectionSocket.send(&#x27;文件不存在\r\n&#x27;.encode(FORMAT))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Close client socket</span></span><br><span class="line">    connectionSocket.close()</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line">serverSocket.close()</span><br><span class="line">sys.exit()</span><br></pre></td></tr></table></figure><h1 id="UDP-ping-程序"><a href="#UDP-ping-程序" class="headerlink" title="UDP ping 程序"></a>UDP ping 程序</h1><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><blockquote><p>下面的代码结合了作业的扩展练习 1:</p><ol><li>Currently, the program calculates the round-trip time for each packet and prints it out individually. Modify this to correspond to the way the standard ping program works. You will need to report the minimum, maximum, and average RTTs at the end of all pings from the client. In addition, calculate the packet loss rate (in percentage).</li></ol></blockquote><h3 id="UDPPingerClient-py"><a href="#UDPPingerClient-py" class="headerlink" title="UDPPingerClient.py"></a>UDPPingerClient.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">PORT = <span class="number">12000</span></span><br><span class="line">FORMAT = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">DISCONNECT_MESSAGE = <span class="string">&#x27;!DISCONNECT&#x27;</span></span><br><span class="line">SERVER = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">ADDR = (SERVER, PORT)</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">time_queue = []</span><br><span class="line">loss_number = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">msg</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        message = msg.encode(FORMAT)</span><br><span class="line">        b = time.time()</span><br><span class="line">        client.sendto(message, ADDR)</span><br><span class="line">        client.settimeout(<span class="number">0.1</span>)</span><br><span class="line">        modified_msg = client.recv(<span class="number">2048</span>).decode()</span><br><span class="line">        a = time.time()</span><br><span class="line">        time_queue.append(a-b)</span><br><span class="line">        print(<span class="string">f&quot;RESPONSE: <span class="subst">&#123;modified_msg&#125;</span>&quot;</span>)</span><br><span class="line">        print(<span class="string">f&quot;RTT: <span class="subst">&#123;time_queue[-<span class="number">1</span>]&#125;</span>s&quot;</span>)</span><br><span class="line">    <span class="comment"># print(client.recv(2048).decode())</span></span><br><span class="line">    <span class="keyword">except</span> socket.timeout:</span><br><span class="line">        <span class="keyword">global</span> loss_number</span><br><span class="line">        loss_number += <span class="number">1</span></span><br><span class="line">        print(<span class="string">&quot;Request timed out!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">11</span>):</span><br><span class="line">    send(<span class="string">f&quot;Ping <span class="subst">&#123;i&#125;</span> <span class="subst">&#123;time.asctime()&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    client.close()</span><br><span class="line">    print(<span class="string">f&quot;&quot;&quot;---ping statics---</span></span><br><span class="line"><span class="string">10 transmitted, <span class="subst">&#123;<span class="number">10</span> - loss_number&#125;</span> received, <span class="subst">&#123;loss_number/<span class="number">10</span>:<span class="number">.2</span>%&#125;</span> loss</span></span><br><span class="line"><span class="string">min/max/avg: <span class="subst">&#123;<span class="built_in">min</span>(time_queue):f&#125;</span>/<span class="subst">&#123;<span class="built_in">max</span>(time_queue):f&#125;</span>/<span class="subst">&#123;<span class="built_in">sum</span>(time_queue)/<span class="number">10</span>:f&#125;</span> s</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># send(input())</span></span><br></pre></td></tr></table></figure><h3 id="UDPPingerServer-py"><a href="#UDPPingerServer-py" class="headerlink" title="UDPPingerServer.py"></a>UDPPingerServer.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># We will need the following module to generate randomized lost packets</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a UDP socket</span></span><br><span class="line"><span class="comment"># Notice the use of SOCK_DGRAM for UDP packets</span></span><br><span class="line">serverSocket = socket(AF_INET, SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Assign IP address and port number to socket</span></span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>, <span class="number">12000</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment"># Generate random number in the range of 0 to 10</span></span><br><span class="line">    rand = random.randint(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="comment"># Receive the    client packet along with the address it is coming from</span></span><br><span class="line">    message, address = serverSocket.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    <span class="comment"># Capitalize the message from the client</span></span><br><span class="line">    message = message.upper()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If rand is less is than 4, we consider the packet lost and do not respond</span></span><br><span class="line">    <span class="keyword">if</span> rand &lt; <span class="number">4</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Otherwise, the server responds</span></span><br><span class="line">    serverSocket.sendto(message, address</span><br></pre></td></tr></table></figure><h2 id="心跳包（Heartbeat-packets）"><a href="#心跳包（Heartbeat-packets）" class="headerlink" title="心跳包（Heartbeat packets）"></a>心跳包（Heartbeat packets）</h2><h3 id="UDPHeartbeatClient-py"><a href="#UDPHeartbeatClient-py" class="headerlink" title="UDPHeartbeatClient.py"></a>UDPHeartbeatClient.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PORT = <span class="number">12000</span></span><br><span class="line">FORMAT = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">DISCONNECT_MESSAGE = <span class="string">&#x27;!DISCONNECT&#x27;</span></span><br><span class="line">SERVER = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">ADDR = (SERVER, PORT)</span><br><span class="line"></span><br><span class="line">client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line">noTransferSequence = <span class="literal">True</span></span><br><span class="line">sequenceLength = <span class="number">5</span>  <span class="comment"># 指定message的发送格式，以序列 12 为例：f&quot;   12&#123;TIME&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">listen_recv</span>():</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        print(client.recv(<span class="number">2048</span>).decode())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_length</span>():</span></span><br><span class="line">    <span class="keyword">global</span> noTransferSequence</span><br><span class="line">    <span class="keyword">while</span> noTransferSequence:</span><br><span class="line">        client.sendto(<span class="built_in">str</span>(sequenceLength).encode(FORMAT), ADDR)</span><br><span class="line">        status = client.recv(<span class="number">2048</span>).decode()</span><br><span class="line">        <span class="keyword">if</span> status == <span class="string">&#x27;Length OK&#x27;</span>:</span><br><span class="line">            noTransferSequence = <span class="literal">False</span></span><br><span class="line">            <span class="comment"># 创建线程监听收到的信息</span></span><br><span class="line">            threading.Thread(target=listen_recv).start()</span><br><span class="line"></span><br><span class="line">        print(status)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">msg</span>):</span></span><br><span class="line">    send_length()</span><br><span class="line">    client.sendto(msg.encode(FORMAT), ADDR)</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    message = <span class="string">f&quot;<span class="subst">&#123;i:&#123;sequenceLength&#125;</span>&#125;<span class="subst">&#123;time.time()&#125;</span>&quot;</span>  <span class="comment"># message[:sequenceLength]存放序列号</span></span><br><span class="line">    send(message)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># send(input())</span></span><br></pre></td></tr></table></figure><h3 id="UDPHeartbeatServer-py"><a href="#UDPHeartbeatServer-py" class="headerlink" title="UDPHeartbeatServer.py"></a>UDPHeartbeatServer.py</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">time.time()在不同平台上可能会有不同表现，这里仅为了本地演示</span></span><br><span class="line"><span class="string">ps: 对心跳包不太了解，按自己理解做了个简单的</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We will need the following module to generate randomized lost packets</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a UDP socket</span></span><br><span class="line"><span class="comment"># Notice the use of SOCK_DGRAM for UDP packets</span></span><br><span class="line">serverSocket = socket(AF_INET, SOCK_DGRAM)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Assign IP address and port number to socket</span></span><br><span class="line">serverSocket.bind((<span class="string">&#x27;&#x27;</span>, <span class="number">12000</span>))</span><br><span class="line"></span><br><span class="line">TIMEOUT = <span class="number">2</span>  <span class="comment"># 设定心跳包间隔不超过 2 秒</span></span><br><span class="line">sendTimeSequence = []  <span class="comment"># 心跳包时间序列</span></span><br><span class="line"></span><br><span class="line">noSequenceLength = <span class="literal">True</span>  <span class="comment"># 标识是否收到序列长度</span></span><br><span class="line">noThreadMonitoring = <span class="literal">True</span>  <span class="comment"># 标识是否有线程监控超时</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_heatbeat</span>(<span class="params">sequence_length</span>):</span></span><br><span class="line">    <span class="keyword">while</span> sequence_length:</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        now_time = time.time()</span><br><span class="line">        latest_send = sendTimeSequence[-<span class="number">1</span>]  <span class="comment"># 获取最近一次客户端发送心跳包的时间</span></span><br><span class="line">        <span class="keyword">if</span> now_time - latest_send &gt; TIMEOUT:</span><br><span class="line">            serverSocket.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start</span>():</span></span><br><span class="line">    <span class="keyword">global</span> noSequenceLength, noThreadMonitoring</span><br><span class="line">    print(<span class="string">&#x27;Ready to serve&#x27;</span>)</span><br><span class="line">    latest_number = <span class="number">0</span></span><br><span class="line">    sequence_length = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># Generate random number in the range of 0 to 10</span></span><br><span class="line">            rand = random.randint(<span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">            <span class="comment"># Receive the    client packet along with the address it is coming from</span></span><br><span class="line">            message, address = serverSocket.recvfrom(<span class="number">1024</span>)</span><br><span class="line">            <span class="comment"># If rand is less is than 1, we consider the packet lost and do not respond</span></span><br><span class="line">            <span class="keyword">if</span> rand &lt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">if</span> noSequenceLength:</span><br><span class="line">                    serverSocket.sendto(<span class="string">b&#x27;Retransmission&#x27;</span>, address)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># Otherwise, the server responds</span></span><br><span class="line">            msg = message.decode()</span><br><span class="line">            <span class="keyword">if</span> noSequenceLength:  <span class="comment"># 此时已经收到序列长度，对第一次收到的序列长度进行处理</span></span><br><span class="line">                sequence_length = <span class="built_in">int</span>(msg[:<span class="number">5</span>])</span><br><span class="line">                noSequenceLength = <span class="literal">False</span></span><br><span class="line">                serverSocket.sendto(<span class="string">b&#x27;Length OK&#x27;</span>, address)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            number = <span class="built_in">int</span>(msg[:sequence_length])</span><br><span class="line">            sendTimeSequence.append(<span class="built_in">float</span>(msg[sequence_length:]))</span><br><span class="line">            <span class="keyword">if</span> noThreadMonitoring:</span><br><span class="line">                threading.Thread(target=handle_heatbeat,args=(sequence_length,)).start()</span><br><span class="line">                noThreadMonitoring = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(latest_number + <span class="number">1</span>, number):  <span class="comment"># 若间隔为1，则代表未丢失，不需回复</span></span><br><span class="line">                serverSocket.sendto(<span class="string">f&#x27;<span class="subst">&#123;i&#125;</span> have lost&#x27;</span>.encode(), address)</span><br><span class="line">            latest_number = number</span><br><span class="line">        <span class="keyword">except</span> OSError:</span><br><span class="line">            print(<span class="string">&#x27;CLOSE&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start()</span><br></pre></td></tr></table></figure><h1 id="邮件客户端"><a href="#邮件客户端" class="headerlink" title="邮件客户端"></a>邮件客户端</h1><p>为选择的是网易的163邮箱作为实验对象，下文中发件邮箱以及收件邮箱都作了更改，可以根据自己的邮箱地址进行替换。</p><table><thead><tr><th>服务器地址</th><th>默认端口号</th><th>SSL协议端口号</th></tr></thead><tbody><tr><td>pop3.163.com</td><td>110</td><td>995</td></tr><tr><td>smtp.163.com</td><td>25</td><td>465/994</td></tr></tbody></table><h2 id="MailClient-py"><a href="#MailClient-py" class="headerlink" title="MailClient.py"></a>MailClient.py</h2><p>smtp.163.com 的默认端口号为 25，建议初学者使用 <code>telnet smtp.163.com 25</code> （com 和 25 之间为<strong>空格</strong>而非<code>:</code>）在终端进行同步的实验，结果一致</p><blockquote><p>提前解释一下， AUTH LOGIN 命令返回的 <code>334 dXNlcm5hbWU6</code>，实际是经过base64加密的 <code>username</code>:，同样的<code>UGFzc3dvcmQ6</code>就是<code>password:</code></p></blockquote><p><img src="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210415163722.png" alt="image-20210415163722750"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 非 SSL 加密</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">msg = <span class="string">&quot;\r\n I love computer networks!&quot;</span> <span class="comment"># 信息前面需空行</span></span><br><span class="line">endmsg = <span class="string">&quot;\r\n.\r\n&quot;</span></span><br><span class="line">recv = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Choose a mail server (e.g. Google mail server) and call it mailserver</span></span><br><span class="line">mailserver = <span class="string">&quot;smtp.163.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create socket called sslClientSocket and establish a TCP connection with mailserver</span></span><br><span class="line">clientSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">clientSocket.connect((mailserver, <span class="number">25</span>))</span><br><span class="line"></span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> recv[-<span class="number">1</span>][:<span class="number">3</span>] != <span class="string">&#x27;220&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;220 reply not received from server.&#x27;</span>)</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send HELO command and print server response.</span></span><br><span class="line">heloCommand = <span class="string">&#x27;HELO Alice\r\n&#x27;</span></span><br><span class="line">clientSocket.send(heloCommand.encode())</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Login</span></span><br><span class="line">LoginCommand = <span class="string">&#x27;AUTH LOGIN\r\n&#x27;</span> <span class="comment"># 要加\r\n，否则会报 504 错误</span></span><br><span class="line">User = <span class="string">b&#x27;你的账户&#x27;</span></span><br><span class="line">Psw = <span class="string">b&#x27;你的密码&#x27;</span></span><br><span class="line"></span><br><span class="line">UserB64 = base64.b64encode(User) <span class="comment"># 账号密码需要base64加密</span></span><br><span class="line">PswB64 = base64.b64encode(Psw)</span><br><span class="line"></span><br><span class="line">clientSocket.send(LoginCommand.encode())</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">clientSocket.send(UserB64 + <span class="string">b&#x27;\r\n&#x27;</span>)</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">clientSocket.send(PswB64 + <span class="string">b&#x27;\r\n&#x27;</span>)</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send MAIL FROM command and print server response.</span></span><br><span class="line"></span><br><span class="line">FromCommand = <span class="string">&#x27;mail from: &lt;your_email_address&gt;\r\n&#x27;</span></span><br><span class="line">clientSocket.send(FromCommand.encode())</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send RCPT TO command and print server response.</span></span><br><span class="line">ToCommand = <span class="string">&#x27;rcpt to: &lt;recipient_email_address&gt;\r\n&#x27;</span></span><br><span class="line">clientSocket.send(ToCommand.encode())</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send DATA command and print server response.</span></span><br><span class="line">DataCommand = <span class="string">&#x27;data&#x27;</span></span><br><span class="line">clientSocket.send(DataCommand.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send message data.</span></span><br><span class="line">header = <span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">from: &lt;your_email_address&gt;</span></span><br><span class="line"><span class="string">to: &lt;recipient_email_address&gt;</span></span><br><span class="line"><span class="string">subject: test</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">clientSocket.send((header + msg).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Message ends with a single period.</span></span><br><span class="line">clientSocket.send(endmsg.encode())</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send QUIT command and get server response.</span></span><br><span class="line">QuitCommand = <span class="string">&#x27;QUIT\r\n&#x27;</span></span><br><span class="line">clientSocket.send(QuitCommand.encode())</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line">recv.append(clientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h2 id="SecureMailClient-py"><a href="#SecureMailClient-py" class="headerlink" title="SecureMailClient.py"></a>SecureMailClient.py</h2><p>此部分为额外的练习，可于终端下使用 <code>openssl s_client -connect smtp.163.com:465</code>加深理解</p><blockquote><p>原文：Mail servers like Google mail (address: smtp.gmail.com, port: 587) requires your client to add a Transport Layer Security (TLS) or Secure Sockets Layer (SSL) for authentication and security reasons, before you send MAIL FROM command. Add TLS/SSL commands to your existing ones and implement your client using Google mail server at above address and port.</p></blockquote><p>因为换个端口号就能使用 SSL 协议，接下来继续用网易做示范。</p><p>smtp.163.com SSL协议的端口号为465/994，任选其一使用</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># SSL 加密</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">msg = <span class="string">&quot;\r\n I love computer networks!&quot;</span></span><br><span class="line">endmsg = <span class="string">&quot;\r\n.\r\n&quot;</span></span><br><span class="line">recv = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># Choose a mail server (e.g. Google mail server) and call it mailserver</span></span><br><span class="line">mailserver = <span class="string">&quot;smtp.163.com&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create socket called sslClientSocket and establish a TCP connection with mailserver</span></span><br><span class="line">clientSocket = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">clientSocket.connect((mailserver, <span class="number">465</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># ssl</span></span><br><span class="line">purpose = ssl.Purpose.SERVER_AUTH</span><br><span class="line">context = ssl.create_default_context(purpose)</span><br><span class="line"></span><br><span class="line">sslClientSocket = context.wrap_socket(clientSocket, server_hostname=mailserver)</span><br><span class="line"></span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> recv[-<span class="number">1</span>][:<span class="number">3</span>] != <span class="string">&#x27;220&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;220 reply not received from server.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"><span class="comment"># Send HELO command and print server response.</span></span><br><span class="line">heloCommand = <span class="string">&#x27;HELO Alice\r\n&#x27;</span></span><br><span class="line">sslClientSocket.send(heloCommand.encode())</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Login</span></span><br><span class="line">LoginCommand = <span class="string">&#x27;AUTH LOGIN\r\n&#x27;</span>  <span class="comment"># 命令要加\r\n</span></span><br><span class="line">User = <span class="string">b&#x27;你的账户&#x27;</span></span><br><span class="line">Psw = <span class="string">b&#x27;你的密码&#x27;</span></span><br><span class="line"></span><br><span class="line">UserB64 = base64.b64encode(User)</span><br><span class="line">PswB64 = base64.b64encode(Psw)</span><br><span class="line"></span><br><span class="line">sslClientSocket.send(LoginCommand.encode())</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line">sslClientSocket.send(UserB64 + <span class="string">b&#x27;\r\n&#x27;</span>)</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line">sslClientSocket.send(PswB64 + <span class="string">b&#x27;\r\n&#x27;</span>)</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send MAIL FROM command and print server response.</span></span><br><span class="line"></span><br><span class="line">FromCommand = <span class="string">&#x27;mail from: &lt;your_email_address&gt;\r\n&#x27;</span></span><br><span class="line">sslClientSocket.send(FromCommand.encode())</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send RCPT TO command and print server response.</span></span><br><span class="line">ToCommand = <span class="string">&#x27;rcpt to: &lt;recipient_email_address&gt;\r\n&#x27;</span></span><br><span class="line">sslClientSocket.send(ToCommand.encode())</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send DATA command and print server response.</span></span><br><span class="line">DataCommand = <span class="string">&#x27;data&#x27;</span></span><br><span class="line">sslClientSocket.send(DataCommand.encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send message data.</span></span><br><span class="line">header = <span class="string">f&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">from: &lt;your_email_address&gt;</span></span><br><span class="line"><span class="string">to: &lt;recipient_email_address&gt;</span></span><br><span class="line"><span class="string">subject: test</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">sslClientSocket.send((header + msg).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># Message ends with a single period.</span></span><br><span class="line">sslClientSocket.send(endmsg.encode())</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send QUIT command and get server response.</span></span><br><span class="line"></span><br><span class="line">QuitCommand = <span class="string">&#x27;QUIT\r\n&#x27;</span></span><br><span class="line">sslClientSocket.send(QuitCommand.encode())</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br><span class="line">recv.append(sslClientSocket.recv(<span class="number">1024</span>).decode())</span><br><span class="line">print(recv[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h2 id="ProxyServer-py"><a href="#ProxyServer-py" class="headerlink" title="ProxyServer.py"></a>ProxyServer.py</h2><blockquote><p>程序从自己手中跑起来的瞬间令人着迷</p></blockquote><p>Mac改代理：在Safari中<code>Command+,</code> -&gt; 高级 -&gt; 更改设置… -&gt; 代理 -&gt; 网页代理 (HTTP) ，点击<strong>好</strong>并且<strong>应用</strong>，测试完记得取消代理。</p><p><img src="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210425171901.png"></p><p><img src="https://blogby.oss-cn-guangzhou.aliyuncs.com/20210425172041.png" alt="image-20210425172041771"></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Test URL：http://gaia.cs.umass.edu/wireshark-labs/HTTP-wireshark-file1.html</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt;= <span class="number">1</span>:</span><br><span class="line">    print(<span class="string">&#x27;Usage : &quot;python ProxyServer.py server_ip&quot;\n&#x27;</span></span><br><span class="line">          <span class="string">&#x27;[server_ip : It is the IP Address Of Proxy Server\n&#x27;</span></span><br><span class="line">          <span class="string">&#x27;The default address is 0.0.0.0&#x27;</span>)</span><br><span class="line">    IP = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># sys.exit(2)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    IP = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">PORT = <span class="number">8086</span></span><br><span class="line">FORMAT = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a server socket, bind it to a port and start listening</span></span><br><span class="line">tcpSerSock = socket(AF_INET, SOCK_STREAM)</span><br><span class="line">tcpSerSock.bind((IP, PORT))</span><br><span class="line">tcpSerSock.listen()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="comment"># Start receiving data from the client</span></span><br><span class="line">    print(<span class="string">&#x27;Ready to serve...&#x27;</span>)</span><br><span class="line">    tcpCliSock, addr = tcpSerSock.accept()</span><br><span class="line">    print(<span class="string">&#x27;Received a connection from:&#x27;</span>, addr)</span><br><span class="line">    message = tcpCliSock.recv(<span class="number">2048</span>).decode()</span><br><span class="line">    print(message)</span><br><span class="line">    <span class="comment"># Extract the filename from the given message print(message.split()[1])</span></span><br><span class="line">    print(message.split()[<span class="number">1</span>])</span><br><span class="line">    filename = message.split()[<span class="number">1</span>].partition(<span class="string">&quot;//&quot;</span>)[<span class="number">2</span>]</span><br><span class="line">    <span class="comment"># filename = message.split()[1].split(&#x27;:&#x27;)[0]</span></span><br><span class="line">    print(filename)</span><br><span class="line">    fileExist = <span class="string">&quot;false&quot;</span></span><br><span class="line">    filetouse = <span class="string">&quot;./&quot;</span> + filename.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>)</span><br><span class="line">    print(filetouse)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Check wether the file exist in the cache</span></span><br><span class="line">        f = <span class="built_in">open</span>(filetouse, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">        outputdata = f.readlines()</span><br><span class="line">        fileExist = <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="comment"># ProxyServer finds a cache hit and generates a response message</span></span><br><span class="line">        tcpCliSock.send(<span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>.encode())</span><br><span class="line">        tcpCliSock.send(<span class="string">&quot;Content-Type:text/html\r\n&quot;</span>.encode())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Send the content of the requested file to the client</span></span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> outputdata:</span><br><span class="line">            tcpCliSock.send(data.encode(FORMAT))</span><br><span class="line">        tcpCliSock.send(<span class="string">&quot;\r\n&quot;</span>.encode(FORMAT))</span><br><span class="line"></span><br><span class="line">        print(<span class="string">&#x27;Read from cache&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Error handling for file not found in cache</span></span><br><span class="line">    <span class="keyword">except</span> IOError:</span><br><span class="line">        <span class="keyword">if</span> fileExist == <span class="string">&quot;false&quot;</span>:</span><br><span class="line">            <span class="comment"># Create a socket on the proxyserver</span></span><br><span class="line">            c = socket(AF_INET, SOCK_STREAM) <span class="comment"># Fill in start. # Fill in end.</span></span><br><span class="line">            hostn = filename.replace(<span class="string">&quot;www.&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">1</span>).split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            print(<span class="string">f&#x27;Host: <span class="subst">&#123;hostn&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># Connect to the socket to port 80</span></span><br><span class="line">                c.connect((hostn, <span class="number">80</span>))</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Create a temporary file on this socket and ask port 80 for the file requested by the client</span></span><br><span class="line">                fileobj = c.makefile(<span class="string">&#x27;rwb&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">                fileobj.write(message.encode())</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Read the response into b_buffer</span></span><br><span class="line">                b_buffer = fileobj.read() <span class="comment"># 这里没有 decode()</span></span><br><span class="line">                print(b_buffer)</span><br><span class="line">                <span class="comment"># Create a new file in the cache for the requested file.</span></span><br><span class="line">                <span class="comment"># Also send the response in the b_buffer to client socket and the corresponding file in the cache</span></span><br><span class="line">                tcpCliSock.send(b_buffer)</span><br><span class="line"></span><br><span class="line">                tmpFile = <span class="built_in">open</span>(<span class="string">&quot;./&quot;</span> + filename.replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>), <span class="string">&quot;w+b&quot;</span>) <span class="comment"># 事实上这里的路径等于 filetouse</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># https://stackoverflow.com/questions/48639285/a-bytes-like-object-is-required-not-int</span></span><br><span class="line">                tmpFile.write(b_buffer) <span class="comment"># 不要对 bytes 使用 writelines</span></span><br><span class="line">                tmpFile.close()</span><br><span class="line"></span><br><span class="line">                fileobj.close()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                print(<span class="string">&#x27;Illegal request&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># HTTP response message for file not found</span></span><br><span class="line">            tcpCliSock.send(<span class="string">&#x27;404 not found&#x27;</span>.encode())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Close the client and the server sockets</span></span><br><span class="line">    tcpCliSock.close()</span><br><span class="line">tcpSerSock.close()</span><br></pre></td></tr></table></figure></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/nslookup入门命令详解/" rel="bookmark">nslookup入门命令详解</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/Python随笔和项目/" rel="bookmark">Python 随笔&项目</a></div></li></ul><footer class="post-footer"><div class="post-tags"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag"><i class="fa fa-tag"></i> 计算机网络</a> <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a></div><div class="post-nav"><div class="post-nav-item"><a href="/nslookup%E5%85%A5%E9%97%A8%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/" rel="prev" title="nslookup入门命令详解"><i class="fa fa-chevron-left"></i> nslookup入门命令详解</a></div><div class="post-nav-item"></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E4%B8%80%E5%8F%B0%E7%94%B5%E8%84%91%E4%B8%8A%E8%BF%90%E8%A1%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">如何在一台电脑上运行服务器和客户端</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95Web%E6%9C%8D%E5%8A%A1%E5%99%A8%EF%BC%88TCP%EF%BC%89"><span class="nav-text">实现简单Web服务器（TCP）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#webserver-py"><span class="nav-text">webserver.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B-webserver-thread-py"><span class="nav-text">多线程 webserver_thread.py</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#UDP-ping-%E7%A8%8B%E5%BA%8F"><span class="nav-text">UDP ping 程序</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UDPPingerClient-py"><span class="nav-text">UDPPingerClient.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UDPPingerServer-py"><span class="nav-text">UDPPingerServer.py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BF%83%E8%B7%B3%E5%8C%85%EF%BC%88Heartbeat-packets%EF%BC%89"><span class="nav-text">心跳包（Heartbeat packets）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#UDPHeartbeatClient-py"><span class="nav-text">UDPHeartbeatClient.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UDPHeartbeatServer-py"><span class="nav-text">UDPHeartbeatServer.py</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%82%AE%E4%BB%B6%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-text">邮件客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MailClient-py"><span class="nav-text">MailClient.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SecureMailClient-py"><span class="nav-text">SecureMailClient.py</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxyServer-py"><span class="nav-text">ProxyServer.py</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">J</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">11</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Hoper-J" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hoper-J" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a></span></div><div class="cc-license motion-element" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener external nofollow noreferrer" target="_blank"><img src="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">J</span></div><div class="busuanzi-count"><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-divider">|</span> <span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/pjax/pjax.min.js"></script><script src="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/js/utils.js"></script><script src="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/js/schemes/muse.js"></script><script src="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/js/next-boot.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script data-pjax>!function(){var e,t,o,n,r,a=document.getElementsByTagName("link");if(0<a.length)for(i=0;i<a.length;i++)"canonical"==a[i].rel.toLowerCase()&&a[i].href&&(e=a[i].href);t=e?e.split(":")[0]:window.location.protocol.split(":")[0],e=e||window.location.href,window,n=e,r=document.referrer,/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(n)||(o="https"===String(t).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif",r?(o+="?r="+encodeURIComponent(document.referrer),n&&(o+="&l="+n)):n&&(o+="?l="+n),(new Image).src=o)}()</script><script src="//cdn.jsdelivr.net/gh/Hoper-J/Hoper-J.github.io@master/js/local-search.js"></script><div id="pjax"><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'zU57kswwit7LahvyniJCflh6-gzGzoHsz',
      appKey     : 'S6R7d6LM34bz0ouyDvVEFIkL',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></div></body></html>